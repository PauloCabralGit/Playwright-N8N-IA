name: Playwright Tests

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm install
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      - name: Trigger remote test-runner (or run locally if RUNNER_URL not set)
        env:
          SF_URL: ${{ secrets.SF_URL }}
          SF_LOGIN: ${{ secrets.SF_LOGIN }}
          SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
          RUNNER_URL: ${{ secrets.RUNNER_URL }}
          RUNNER_API_KEY: ${{ secrets.RUNNER_API_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${RUNNER_URL:-}" ]; then
            echo "RUNNER_URL not provided â€” running tests locally"
            npm test
            exit $?
          fi

          echo "Triggering remote runner at $RUNNER_URL"
          sudo apt-get update >/dev/null
          sudo apt-get install -y jq >/dev/null

          CURL_OPTS=( -sS )
          if [ -n "${RUNNER_API_KEY:-}" ]; then
            CURL_OPTS+=( -H "Authorization: Bearer ${RUNNER_API_KEY}" )
          fi
          CURL_OPTS+=( -H "Content-Type: application/json" )

          PAYLOAD=$(jq -n --arg ambiente "preprod" \
            --arg sf_url "${SF_URL:-}" \
            --arg sf_login "${SF_LOGIN:-}" \
            --arg sf_password "${SF_PASSWORD:-}" \
            '{ambiente:$ambiente, env: {SF_URL:$sf_url, SF_LOGIN:$sf_login, SF_PASSWORD:$sf_password}}')

          echo "Payload: $PAYLOAD"

          RESP=$(curl "${CURL_OPTS[@]}" -d "$PAYLOAD" "$RUNNER_URL/run-tests")
          echo "Response: $RESP"
          EXEC_ID=$(echo "$RESP" | jq -r .execution_id)
          if [ -z "$EXEC_ID" ] || [ "$EXEC_ID" = "null" ]; then
            echo "Failed to start remote execution" >&2
            exit 1
          fi

          echo "Execution id: $EXEC_ID"

          # Poll for completion
          while true; do
            DETAILS=$(curl "${CURL_OPTS[@]}" "$RUNNER_URL/execution-details/$EXEC_ID")
            STATUS=$(echo "$DETAILS" | jq -r .status // empty)
            echo "Status: $STATUS"
            if [ "$STATUS" != "running" ] && [ "$STATUS" != "queued" ] && [ -n "$STATUS" ]; then
              break
            fi
            sleep 5
          done

          echo "$DETAILS" > execution-$EXEC_ID.json
          echo "Saved execution details to execution-$EXEC_ID.json"

          # Try to download the generated report zip (if the runner produced one)
          REPORT_URL="$RUNNER_URL/execution-report/$EXEC_ID"
          echo "Attempting to download report from $REPORT_URL"
          HTTP_CODE=0
          set +e
          if [ -n "${RUNNER_API_KEY:-}" ]; then
            curl -sS -H "Authorization: Bearer ${RUNNER_API_KEY}" -o execution-$EXEC_ID-report.zip -w "%{http_code}" "$REPORT_URL" > /tmp/report_http_code 2>/dev/null || true
          else
            curl -sS -o execution-$EXEC_ID-report.zip -w "%{http_code}" "$REPORT_URL" > /tmp/report_http_code 2>/dev/null || true
          fi
          HTTP_CODE=$(cat /tmp/report_http_code || echo 0)
          set -e
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Downloaded report to execution-$EXEC_ID-report.zip"
          else
            echo "No report found at $REPORT_URL (HTTP $HTTP_CODE)"
            rm -f execution-$EXEC_ID-report.zip || true
          fi

      - name: Upload Playwright report and execution details
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report
            execution-*.json
            execution-*-report.zip
